<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>DailyTransactions.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">AllTests (Apr 10, 2013 12:41:39 AM)</a> &gt; <a href="../../index.html" class="el_group">BackEnd</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.html" class="el_package">default</a> &gt; <span class="el_source">DailyTransactions.java</span></div><h1>DailyTransactions.java</h1><pre class="source lang-java linenums">/**
 * Swift Ticket -- Back End
 *
 * Copyright (C) 2013, Jonathan Gillett, Daniel Smullen, and Rayan Alfaheid
 * All rights reserved.
 *
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
import java.io.BufferedReader;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.IOException;
import java.util.ArrayList;
import java.util.concurrent.CopyOnWriteArrayList;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * DailyTransactions Provides methods and attributes for interacting with the
 * daily transactions file in memory, and outputting to disk.
 * 
 * @author Jonathan Gillett
 * @author Daniel Smullen
 * @author Rayan Alfaheid
 */
public class DailyTransactions
{
    private CopyOnWriteArrayList&lt;String&gt; mergedTransactions;
    private ArrayList&lt;Transaction&gt; transactions;
    private String mergedDTF;


    /**
     * Constructor for the class. Takes the path to the available tickets file, and opens it.
     * 
     * @param mergedDTF String containing the path to the file containing the merged daily
     * transaction files.
     * 
     * @throws FatalError Fatal errors occur under the following circumstances:
     * 			&lt;br&gt;The Daily Transaction file is missing, or not found at the path specified.
     * @throws IOException 
     */
<span class="fc" id="L56">    public DailyTransactions(String mergedDTF) throws FatalError, IOException</span>
    {
<span class="fc" id="L58">        this.mergedDTF = mergedDTF;</span>
<span class="fc" id="L59">        this.mergedTransactions = new CopyOnWriteArrayList&lt;String&gt;();</span>
<span class="fc" id="L60">        this.transactions = new ArrayList&lt;Transaction&gt;();</span>
        
        /* Load the contents of the merged daily transaction files */
<span class="fc" id="L63">        load();</span>
        
        /* Parse the merged transactions */
<span class="fc" id="L66">        parse();</span>
<span class="fc" id="L67">    }</span>

    /**
     * Provides a handle to the ArrayList of transactions
     * that comprise the daily transaction file.
     * 
     * @return Returns an ArrayList of Transaction objects, representing
     * all entries in the daily transaction file.
     */
    public ArrayList&lt;Transaction&gt; getTransactions()
    {
<span class="fc" id="L78">        return transactions;</span>
    }

    
    /**
     * Load the contents of the merged collection of all daily transaction files
     * into a single array containing each transaction as a line.
     * 
     * @throws FatalError Fatal errors occur under the following circumstances:
     * 			&lt;br&gt;The Daily Transaction file is missing, or not found at the path specified.
     *      	&lt;br&gt;The Daily Transaction file is corrupt. 
     * @throws IOException 
     */
    @SuppressWarnings(&quot;resource&quot;)
    private void load() throws FatalError, IOException
    {
        BufferedReader reader;
        String line;
<span class="fc" id="L96">        File file = new File(mergedDTF);</span>
        
        try
        {
<span class="fc" id="L100">            reader = new BufferedReader(new FileReader(file));</span>
<span class="fc" id="L101">        }</span>
<span class="fc" id="L102">        catch (FileNotFoundException e1)</span>
        {
<span class="fc" id="L104">            e1.printStackTrace();</span>
<span class="fc" id="L105">            throw new FatalError(ExceptionCodes.DTF_NOT_FOUND, file.getPath());</span>
        }

<span class="fc bfc" id="L108" title="All 2 branches covered.">        while ((line = reader.readLine()) != null)</span>
        {                        
            /* If the DTF entry is valid add it to the merged list of transactions */
<span class="fc bfc" id="L111" title="All 2 branches covered.">            if (Validate.dtfEntry(line))</span>
            {
<span class="fc" id="L113">                mergedTransactions.add(line.trim());</span>
<span class="fc" id="L114">            }</span>
            else
            {
<span class="fc" id="L117">                throw new FatalError(ExceptionCodes.CORRUPT_DTF, file.getPath());</span>
            }
        }
<span class="fc" id="L120">        reader.close();</span>
<span class="fc" id="L121">    }</span>

    /**
     * Reads in the contents of merged daily transaction files, and converts them into
     * Transaction entries. Entries which do not conform to the standards for entries are
     * considered corrupted and unreadable.
     * 
     * @throws FatalError Fatal errors occur under the following circumstances:
     *      	&lt;br&gt;The Daily Transaction file is corrupt. 
     */
    private void parse() throws FatalError
    {
        /* Get the transaction code */
<span class="fc" id="L134">        Pattern reCode = Pattern.compile(&quot;^([0-9]{2})_.*$&quot;);</span>
        
        /* Lookahead regular expression for the logout transaction, used to get buyer */
<span class="fc" id="L137">        Pattern reLookAhead = Pattern.compile(&quot;^(00)_([A-Za-z0-9_]{1,15}?)_+(AA|FS|BS|SS)_([0-9]{6}\\.[0-9]{2})$&quot;);</span>
        
        /* Daily transaction entry matches logout, create, delete, or addcredit */
<span class="fc" id="L140">        Pattern reUserMod = Pattern.compile(&quot;^(00|01|02|06)_([A-Za-z0-9_]{1,15}?)_+(AA|FS|BS|SS)_([0-9]{6}\\.[0-9]{2})$&quot;);</span>

        /* Daily transaction entry matches refund */
<span class="fc" id="L143">        Pattern reRefund = Pattern.compile(&quot;^(05)_([A-Za-z0-9_]{1,15}?)_+([A-Za-z0-9_]{1,15}?)_+([0-9]{6}\\.[0-9]{2})$&quot;);</span>

        /* Daily transaction entry matches buy or sell */
<span class="fc" id="L146">        Pattern reBuySell = Pattern.compile(&quot;^(03|04)_(.{1,19}?)_+_([A-Za-z0-9_]{1,15}?)_+([0-9]{3})_([0-9]{3}\\.[0-9]{2})$&quot;);</span>

        Matcher match;
        
        /* Parse each entry in the merged transactions */
<span class="fc bfc" id="L151" title="All 2 branches covered.">        for (String entry : mergedTransactions)</span>
        {
            /* Get the transaction code and create the appropriate object */
<span class="fc" id="L154">            match = reCode.matcher(entry);</span>
            
            /* logout, create, delete, or addcredit transaction */
<span class="pc bpc" id="L157" title="1 of 4 branches missed.">            if (match.matches() &amp;&amp; match.group(1).matches(&quot;(00|01|02|06)&quot;))</span>
            {
<span class="fc" id="L159">                match = reUserMod.matcher(entry);</span>
<span class="fc" id="L160">                match.matches();</span>
                
<span class="fc" id="L162">                String username = match.group(2);</span>
<span class="fc" id="L163">                String type = match.group(3);</span>
<span class="fc" id="L164">                Double credit = Double.parseDouble(match.group(4));</span>
                
                /* Add a logout transaction */
<span class="fc bfc" id="L167" title="All 2 branches covered.">                if (match.group(1).equals(&quot;00&quot;))</span>
                {
<span class="fc" id="L169">                    transactions.add(new Logout(username, type, credit, entry));</span>
<span class="fc" id="L170">                }</span>
                /* Add a create transaction */
<span class="fc bfc" id="L172" title="All 2 branches covered.">                else if (match.group(1).equals(&quot;01&quot;))</span>
                {
<span class="fc" id="L174">                    transactions.add(new Create(username, type, credit, entry));</span>
<span class="fc" id="L175">                }</span>
                /* Add a delete transaction */
<span class="fc bfc" id="L177" title="All 2 branches covered.">                else if (match.group(1).equals(&quot;02&quot;))</span>
                {
<span class="fc" id="L179">                    transactions.add(new Delete(username, type, credit, entry));</span>
<span class="fc" id="L180">                }</span>
                /* Add a addcredit transaction */
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">                else if (match.group(1).equals(&quot;06&quot;))</span>
                {
<span class="fc" id="L184">                    transactions.add(new AddCredit(username, type, credit, entry));</span>
                }
<span class="fc" id="L186">            }</span>
            /* Refund transactions */
<span class="fc bfc" id="L188" title="All 2 branches covered.">            else if (match.group(1).matches(&quot;05&quot;))</span>
            {
<span class="fc" id="L190">                match = reRefund.matcher(entry);</span>
<span class="fc" id="L191">                match.matches();</span>
                
<span class="fc" id="L193">                String buyer = match.group(2);</span>
<span class="fc" id="L194">                String seller = match.group(3);</span>
<span class="fc" id="L195">                Double credit = Double.parseDouble(match.group(4));</span>
                
<span class="fc" id="L197">                transactions.add(new Refund(buyer, seller, credit, entry));</span>
<span class="fc" id="L198">            }</span>
            /* Buy and sell transactions */
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">            else if (match.group(1).matches(&quot;(03|04)&quot;))</span>
            {
<span class="fc" id="L202">                match = reBuySell.matcher(entry);</span>
<span class="fc" id="L203">                match.matches();</span>
                
                /* Replace each _ in the event title with a space character */
<span class="fc" id="L206">                String event = match.group(2).replace('_', ' ');</span>
<span class="fc" id="L207">                String seller = match.group(3);</span>
<span class="fc" id="L208">                Integer volume = Integer.parseInt(match.group(4));</span>
<span class="fc" id="L209">                Double price = Double.parseDouble(match.group(5));</span>
                
                /* Add a sell transaction */
<span class="fc bfc" id="L212" title="All 2 branches covered.">                if (match.group(1).equals(&quot;03&quot;))</span>
                {
<span class="fc" id="L214">                    transactions.add(new Sell(event, seller, volume, price, entry));</span>
<span class="fc" id="L215">                }</span>
                /* Add a buy transaction */
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">                else if (match.group(1).equals(&quot;04&quot;))</span>
                {
                    /* For a buy transaction use a lookahead to get the name of the buyer */
<span class="fc bfc" id="L220" title="All 2 branches covered.">                    for (int i = mergedTransactions.indexOf(entry); i &lt; mergedTransactions.size(); ++i)</span>
                    {
<span class="fc" id="L222">                        match = reLookAhead.matcher(mergedTransactions.get(i));</span>
                        
                        /* If buyer is found in lookahead, add transaction with buyer's name */
<span class="fc bfc" id="L225" title="All 2 branches covered.">                        if (match.matches())</span>
                        {
<span class="fc" id="L227">                            transactions.add(new Buy(event, match.group(2), seller, volume, price, entry));</span>
                        }
                    }
                }
            }
        }
<span class="fc" id="L233">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.0.201210061924</span>AllTests (Apr 10, 2013 12:41:39 AM)</div></body></html>